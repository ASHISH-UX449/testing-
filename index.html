<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âš¡ QuickShare Â· Fixed Device Linking</title>
    <!-- Firebase SDK v9 (modular) with CORRECT type="module" -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getDatabase, ref, set, update, onValue, off, get } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';

        // Your Firebase config with CORRECT databaseURL
        const firebaseConfig = {
            apiKey: "AIzaSyA_CTMmmc8gUwEHRP7MXSyT7JR6omemDmU",
            authDomain: "file-shairing.firebaseapp.com",
            databaseURL: "https://file-shairing-default-rtdb.firebaseio.com",
            projectId: "file-shairing",
            storageBucket: "file-shairing.firebasestorage.app",
            messagingSenderId: "519357509068",
            appId: "1:519357509068:web:1f561d82f110b76c8fc169"
        };

        // Initialize Firebase
        try {
            const app = initializeApp(firebaseConfig);
            const database = getDatabase(app);
            console.log("ðŸ”¥ Firebase connected successfully to:", firebaseConfig.databaseURL);

            // Expose database and functions globally for the non-module script
            window.database = database;
            window.ref = ref;
            window.set = set;
            window.update = update;
            window.onValue = onValue;
            window.off = off;
            window.get = get;

            // Dispatch event to signal Firebase is ready
            window.dispatchEvent(new CustomEvent('firebase-ready'));
        } catch (error) {
            console.error("Firebase initialization error:", error);
            // Dispatch error event so UI can show message
            window.dispatchEvent(new CustomEvent('firebase-error', { detail: error.message }));
        }
    </script>

    <!-- QRCode library (generation only) -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * { box-sizing: border-box; margin: 0; font-family: 'Segoe UI', sans-serif; }
        body { background: #0b1120; min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 16px; }
        .glass-card { background: rgba(18, 28, 46, 0.95); backdrop-filter: blur(12px); border-radius: 40px; padding: 32px; width: 100%; max-width: 900px; border: 1px solid #2d3a5e; color: #eef5ff; }
        h1 { font-size: 2.5rem; font-weight: 600; background: linear-gradient(145deg, #a6c9ff, #6ea8fe); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 24px; display: flex; align-items: center; gap: 12px; }
        .button-group { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; margin: 40px 0 20px; }
        .primary-btn { background: #1e2b47; border: none; border-radius: 60px; padding: 20px 48px; font-size: 1.6rem; font-weight: 600; color: white; display: inline-flex; align-items: center; gap: 16px; box-shadow: 0 8px 0 #0d1628; cursor: pointer; border: 1px solid #4285dc; transition: 0.1s; }
        .primary-btn:active { transform: translateY(6px); box-shadow: 0 2px 0 #0d1628; }
        .receive-btn { background: #262e42; border: 1px solid #6d88b0; }
        .panel { background: #101b2bcc; border-radius: 32px; padding: 28px; margin: 24px 0; border: 1px solid #2f4162; }
        .flex-row { display: flex; flex-wrap: wrap; gap: 25px; align-items: flex-start; }
        .qr-box { background: #1a253b; padding: 20px; border-radius: 28px; text-align: center; flex: 1 1 240px; border: 1px solid #3b507a; }
        .qr-box canvas { max-width: 200px; border-radius: 24px; padding: 10px; background: white; margin: 10px 0; }
        .password-area { flex: 2 1 260px; }
        .otp-display { font-family: monospace; font-size: 2.8rem; letter-spacing: 8px; background: #0b121f; padding: 20px; border-radius: 40px; text-align: center; border: 2px dashed #4f74b0; color: #d6e6ff; }
        .input-styled { width: 100%; padding: 18px 24px; font-size: 1.3rem; background: #0e1629; border: 2px solid #31486c; border-radius: 60px; color: white; outline: none; }
        .input-styled:focus { border-color: #6fa3ff; }
        .small-btn { background: #293654; border: none; border-radius: 40px; padding: 14px 28px; font-size: 1.2rem; color: white; display: inline-flex; align-items: center; gap: 10px; cursor: pointer; border: 1px solid #5e7bb6; box-shadow: 0 4px 0 #141e34; }
        .small-btn:active { transform: translateY(4px); box-shadow: none; }
        .badge { background: #1f334f; padding: 6px 16px; border-radius: 40px; font-size: 0.9rem; }
        .file-list { background: #0f1827; border-radius: 30px; padding: 18px; margin-top: 25px; max-height: 300px; overflow-y: auto; }
        .file-item { display: flex; justify-content: space-between; align-items: center; padding: 14px 12px; background: #1a263d; margin: 8px 0; border-radius: 50px; border-left: 6px solid #4f8cff; }
        .file-preview { max-width: 100px; max-height: 60px; border-radius: 12px; object-fit: cover; }
        .status-indicator { display: flex; align-items: center; gap: 12px; font-size: 1.2rem; margin: 20px 0; padding: 15px; background: #1a2842; border-radius: 60px; }
        .dot-pulse { width: 16px; height: 16px; background: #44dd88; border-radius: 50%; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } }
        .link-success { background: #1d3a2a; border-left: 6px solid #2ecc71; }
        .warning-note { background: #2f2645; border-radius: 30px; padding: 12px 22px; border-left: 8px solid #d68b5c; margin-top: 20px; }
        .hidden { display: none !important; }
        .debug-info { font-size: 0.9rem; color: #aaccff; margin-top: 8px; }
        .error-message { background: #4a1e2c; border-left: 6px solid #ff6b6b; padding: 15px; border-radius: 30px; margin: 20px 0; }
    </style>
</head>
<body>
<div class="glass-card">
    <h1><i class="fas fa-bolt" style="color: #f5b342;"></i> QuickShare Â· Fixed Linking</h1>

    <div class="button-group">
        <button class="primary-btn" id="quickShareBtn"><i class="fas fa-upload"></i> Quick Share</button>
        <button class="primary-btn receive-btn" id="receiveBtn"><i class="fas fa-download"></i> Receive Data</button>
    </div>

    <!-- Firebase Error Display (hidden by default) -->
    <div id="firebaseError" class="error-message hidden">
        <i class="fas fa-exclamation-triangle"></i> <span id="errorText">Firebase connection failed</span>
    </div>

    <!-- SHARE PANEL -->
    <div id="sharePanel" class="panel hidden">
        <div class="flex-row">
            <div class="qr-box">
                <i class="fas fa-qrcode fa-2x"></i>
                <div id="qrContainer"></div>
                <div class="badge">scan to connect</div>
            </div>
            <div class="password-area">
                <div style="font-size: 1.2rem; margin-bottom: 10px;"><i class="fa-solid fa-lock"></i> one-time password</div>
                <div id="otpDisplay" class="otp-display">------</div>
                <div id="shareStatusContainer" class="status-indicator">
                    <span class="dot-pulse"></span>
                    <span id="shareStatusText">waiting for receiver...</span>
                </div>
                <div id="shareSuccessContainer" class="status-indicator hidden">
                    <i class="fas fa-check-circle" style="color: #2ecc71; font-size: 24px;"></i>
                    <span>âœ… Device linked! Ready to send files</span>
                </div>
            </div>
        </div>
        
        <!-- File picker - appears after linking -->
        <div id="filePickerSection" class="hidden">
            <hr style="border: 1px solid #2f446a; margin: 20px 0;">
            <div style="display: flex; gap: 18px; align-items: center; flex-wrap: wrap;">
                <button class="small-btn" id="selectFileBtn"><i class="fas fa-folder-open"></i> Select File</button>
                <span id="selectedFileHint">no file selected</span>
            </div>
            <div id="sharedPreview" class="file-list"></div>
        </div>
    </div>

    <!-- RECEIVE PANEL -->
    <div id="receivePanel" class="panel hidden">
        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
            <div style="flex: 2; min-width: 260px;">
                <label><i class="fas fa-key"></i> Enter password</label>
                <input type="text" id="receiveOtpInput" class="input-styled" placeholder="e.g. ABC123" maxlength="6" style="text-transform: uppercase;">
                
                <div style="margin: 20px 0; display: flex; gap: 14px; flex-wrap: wrap;">
                    <button class="small-btn" id="submitOtpBtn"><i class="fas fa-plug"></i> Link Device</button>
                </div>
                <div class="debug-info" id="receiveDebug">Enter the 6-character code shown on sender</div>
            </div>
            <div class="qr-box" style="flex: 1;">
                <p>Scan QR from sender</p>
                <i class="fas fa-qrcode fa-3x" style="opacity: 0.7;"></i>
                <div><span class="badge">manual entry only</span></div>
            </div>
        </div>

        <!-- Receiver status -->
        <div id="receiverStatusContainer" class="status-indicator hidden">
            <span class="dot-pulse"></span>
            <span id="receiverStatusText">linking...</span>
        </div>
        
        <div id="receiverSuccessContainer" class="status-indicator link-success hidden">
            <i class="fas fa-check-circle" style="color: #2ecc71; font-size: 24px;"></i>
            <span>âœ… Linked! Waiting for file...</span>
        </div>

        <!-- Received file display -->
        <div id="receiveFileContainer" class="hidden">
            <h3 style="margin: 20px 0 10px;">Received File:</h3>
            <div id="receiveFileList" class="file-list"></div>
        </div>
    </div>

    <div class="warning-note">
        <i class="fa-solid fa-shield-halved"></i> One-time password Â· Files transfer via Firebase Â· Fixed device linking
    </div>
</div>

<script>
// Main application script - waits for Firebase to be ready
(function() {
    let database, ref, set, update, onValue, off, get;
    let firebaseReady = false;
    
    // DOM elements for error display
    const firebaseErrorDiv = document.getElementById('firebaseError');
    const errorTextSpan = document.getElementById('errorText');
    
    // Listen for Firebase ready event
    window.addEventListener('firebase-ready', () => {
        console.log('Firebase ready, starting app...');
        database = window.database;
        ref = window.ref;
        set = window.set;
        update = window.update;
        onValue = window.onValue;
        off = window.off;
        get = window.get;
        firebaseReady = true;
        
        // Hide error if previously shown
        if (firebaseErrorDiv) firebaseErrorDiv.classList.add('hidden');
        
        // Initialize the app
        initApp();
    });

    // Listen for Firebase error event
    window.addEventListener('firebase-error', (e) => {
        console.error('Firebase error:', e.detail);
        if (firebaseErrorDiv && errorTextSpan) {
            errorTextSpan.innerText = 'Firebase connection failed: ' + e.detail;
            firebaseErrorDiv.classList.remove('hidden');
        }
    });

    // Fallback timeout (just in case, but with type="module" this should rarely trigger)
    setTimeout(() => {
        if (!firebaseReady) {
            console.error('Firebase initialization timeout');
            if (firebaseErrorDiv && errorTextSpan) {
                errorTextSpan.innerText = 'Firebase connection timeout. Please refresh the page.';
                firebaseErrorDiv.classList.remove('hidden');
            }
        }
    }, 8000);

    // Core application logic
    function initApp() {
        // DOM elements
        const shareBtn = document.getElementById('quickShareBtn');
        const receiveBtn = document.getElementById('receiveBtn');
        const sharePanel = document.getElementById('sharePanel');
        const receivePanel = document.getElementById('receivePanel');
        const otpDisplay = document.getElementById('otpDisplay');
        const qrContainer = document.getElementById('qrContainer');
        const shareStatusContainer = document.getElementById('shareStatusContainer');
        const shareSuccessContainer = document.getElementById('shareSuccessContainer');
        const shareStatusText = document.getElementById('shareStatusText');
        const filePickerSection = document.getElementById('filePickerSection');
        const selectFileBtn = document.getElementById('selectFileBtn');
        const selectedFileHint = document.getElementById('selectedFileHint');
        const sharedPreview = document.getElementById('sharedPreview');
        
        const receiveOtpInput = document.getElementById('receiveOtpInput');
        const submitOtpBtn = document.getElementById('submitOtpBtn');
        const receiverStatusContainer = document.getElementById('receiverStatusContainer');
        const receiverSuccessContainer = document.getElementById('receiverSuccessContainer');
        const receiverStatusText = document.getElementById('receiverStatusText');
        const receiveFileContainer = document.getElementById('receiveFileContainer');
        const receiveFileList = document.getElementById('receiveFileList');
        const receiveDebug = document.getElementById('receiveDebug');

        // State
        let currentOtp = null;
        let shareRef = null;
        let shareListener = null;
        let receiverListener = null;

        // Helper: generate random 6-char OTP
        function generateOtp() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ0123456789';
            let otp = '';
            for (let i = 0; i < 6; i++) {
                otp += chars[Math.floor(Math.random() * chars.length)];
            }
            return otp;
        }

        // Reset sender state
        function resetShare() {
            // Clean up previous listener
            if (shareRef && shareListener) {
                off(shareRef);
            }
            
            currentOtp = generateOtp();
            otpDisplay.innerText = currentOtp;
            qrContainer.innerHTML = '';
            
            // Generate QR code
            QRCode.toCanvas(document.createElement('canvas'), currentOtp, { width: 200 }, (err, canvas) => {
                if (err) {
                    qrContainer.innerHTML = '<p>QR Error</p>';
                    return;
                }
                qrContainer.appendChild(canvas);
            });
            
            // Reset UI
            shareStatusContainer.classList.remove('hidden');
            shareSuccessContainer.classList.add('hidden');
            filePickerSection.classList.add('hidden');
            selectedFileHint.innerText = 'no file selected';
            sharedPreview.innerHTML = '';
            
            // Create Firebase reference
            const path = `shares/${currentOtp}`;
            const dbRef = ref(database, path);
            shareRef = dbRef;
            
            // Initialize database entry
            set(dbRef, {
                otp: currentOtp,
                linked: false,
                file: null,
                timestamp: Date.now()
            }).catch(e => {
                console.error("Firebase set error:", e);
                alert("Failed to create share session. Check Firebase permissions.");
            });
            
            // Listen for changes (especially 'linked' flag)
            shareListener = onValue(dbRef, (snapshot) => {
                const data = snapshot.val();
                if (!data) return;
                
                console.log("Sender update:", data);
                
                // When receiver links, update UI
                if (data.linked === true) {
                    shareStatusContainer.classList.add('hidden');
                    shareSuccessContainer.classList.remove('hidden');
                    filePickerSection.classList.remove('hidden');
                }
            });
        }

        // Display received file on receiver side
        function displayReceivedFile(fileData) {
            const { name, type, dataURL } = fileData;
            let preview = '';
            
            if (type.startsWith('image/')) {
                preview = `<img src="${dataURL}" class="file-preview" alt="preview">`;
            } else if (type.startsWith('video/')) {
                preview = `<video controls class="file-preview" src="${dataURL}"></video>`;
            } else {
                preview = `<i class="fas fa-file fa-3x"></i>`;
            }
            
            receiveFileList.innerHTML = `
                <div class="file-item">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        ${preview}
                        <div>
                            <strong>${name}</strong><br>
                            <span class="badge">${(fileData.size / 1024).toFixed(1)} KB</span>
                        </div>
                    </div>
                    <a href="${dataURL}" download="${name}" style="color: #9bc0ff;">
                        <i class="fas fa-download fa-xl"></i>
                    </a>
                </div>
            `;
        }

        // --- Event Listeners for UI ---

        // Show share panel
        shareBtn.addEventListener('click', () => {
            sharePanel.classList.remove('hidden');
            receivePanel.classList.add('hidden');
            if (firebaseReady) {
                resetShare();
            } else {
                alert('Firebase not ready yet. Please wait or refresh.');
            }
        });

        // Show receive panel
        receiveBtn.addEventListener('click', () => {
            receivePanel.classList.remove('hidden');
            sharePanel.classList.add('hidden');
            receiveOtpInput.value = '';
            receiverStatusContainer.classList.add('hidden');
            receiverSuccessContainer.classList.add('hidden');
            receiveFileContainer.classList.add('hidden');
            receiveFileList.innerHTML = '';
            if (receiveDebug) receiveDebug.innerText = 'Enter the 6-character code shown on sender';
        });

        // Receiver submits OTP to link
        submitOtpBtn.addEventListener('click', () => {
            if (!firebaseReady) {
                alert('Firebase not ready yet. Please wait or refresh.');
                return;
            }
            
            const otp = receiveOtpInput.value.trim().toUpperCase();
            if (!otp || otp.length !== 6) {
                alert('Please enter a valid 6-character password');
                return;
            }
            
            receiverStatusContainer.classList.remove('hidden');
            receiverStatusText.innerText = 'Linking...';
            if (receiveDebug) receiveDebug.innerText = `Attempting to link with OTP: ${otp}`;
            
            const path = `shares/${otp}`;
            const dbRef = ref(database, path);
            
            // First check if session exists
            get(dbRef).then((snap) => {
                if (!snap.exists()) {
                    alert('Invalid password or session expired');
                    receiverStatusContainer.classList.add('hidden');
                    if (receiveDebug) receiveDebug.innerText = 'Session not found';
                    return;
                }
                
                // Mark as linked
                update(dbRef, { linked: true, receiverTimestamp: Date.now() })
                    .then(() => {
                        receiverStatusContainer.classList.add('hidden');
                        receiverSuccessContainer.classList.remove('hidden');
                        if (receiveDebug) receiveDebug.innerText = 'Linked successfully! Waiting for file...';
                        
                        // Clean up any previous listener
                        if (receiverListener) {
                            off(dbRef, 'value', receiverListener);
                        }
                        
                        // Listen for file arrival
                        receiverListener = onValue(dbRef, (snap2) => {
                            const data = snap2.val();
                            if (data && data.file && data.file.dataURL) {
                                // File received!
                                displayReceivedFile(data.file);
                                receiveFileContainer.classList.remove('hidden');
                                receiverSuccessContainer.classList.add('hidden');
                                if (receiveDebug) receiveDebug.innerText = 'File received!';
                                
                                // Stop listening
                                off(dbRef, 'value', receiverListener);
                            }
                        });
                    })
                    .catch(e => {
                        alert('Link error: ' + e.message);
                        receiverStatusContainer.classList.add('hidden');
                        if (receiveDebug) receiveDebug.innerText = 'Error: ' + e.message;
                    });
            }).catch(e => {
                alert('Error accessing session: ' + e.message);
                receiverStatusContainer.classList.add('hidden');
                if (receiveDebug) receiveDebug.innerText = 'Error: ' + e.message;
            });
        });

        // Sender selects a file to send
        selectFileBtn.addEventListener('click', () => {
            if (!firebaseReady) {
                alert('Firebase not ready yet. Please wait or refresh.');
                return;
            }
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '*/*';
            
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                selectedFileHint.innerText = `ðŸ“ ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
                
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const dataURL = ev.target.result;
                    const fileData = {
                        name: file.name,
                        type: file.type,
                        dataURL: dataURL,
                        size: file.size
                    };
                    
                    // Show preview
                    sharedPreview.innerHTML = '';
                    const previewDiv = document.createElement('div');
                    previewDiv.className = 'file-item';
                    
                    if (file.type.startsWith('image/')) {
                        previewDiv.innerHTML = `<img src="${dataURL}" class="file-preview"> <span>${file.name}</span>`;
                    } else if (file.type.startsWith('video/')) {
                        previewDiv.innerHTML = `<video controls class="file-preview" src="${dataURL}"></video> <span>${file.name}</span>`;
                    } else {
                        previewDiv.innerHTML = `<i class="fas fa-file fa-2x"></i> <span>${file.name}</span>`;
                    }
                    
                    sharedPreview.appendChild(previewDiv);
                    
                    // Send to Firebase
                    if (shareRef && currentOtp) {
                        update(shareRef, { file: fileData })
                            .then(() => {
                                shareStatusText.innerText = 'File sent successfully!';
                            })
                            .catch(e => alert('Send error: ' + e.message));
                    } else {
                        alert('No active share session. Please start a new share.');
                    }
                };
                
                reader.readAsDataURL(file);
            };
            
            input.click();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (shareRef && currentOtp && firebaseReady) {
                set(shareRef, {}); // Remove session data
            }
            if (shareRef && shareListener && firebaseReady) {
                off(shareRef);
            }
        });

        console.log('App initialized with Firebase database');
    }
})();
</script>
</body>
</html>